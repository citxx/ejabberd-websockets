ejabberd-websockets
===================

Модуль добавляет поддержку [XMPP over WebSocket](https://tools.ietf.org/html/rfc7395)
в ejabberd.


Использование
-------------

После установки для подключения модуля необходимо в файл /etc/ejabberd/ejabberd.cfg
в секцию *modules* добавить кортеж

    {mod_websocket, []}

и в секцию *listen* добавить кортеж

    {5288, websocket_session, [
      {request_handlers, [{["ws-xmpp"], mod_websocket}]},
      {tls, true},
      {certfile, "/path/to/certificate.pem"}
    ]}

Здесь 5288 - порт, на котором ejabberd будет принимать WebSocket соединения.
Если не требуется поддержка шифрования, то можно убрать строки {tls, true} и
путь к файлу сертификата.

После изменения конфигурации необходимо перезапустить ejabberd.


Архитектура
-----------

### mod\_websocket.erl

Запускает *simple_one_for_one* супервизор, который позволяет запускать процессы
*websocket_xmpp*.

### websocket\_session.erl

Конечный автомат, принимающий данные из сокета и передающий payload в
*websocket_xmpp*. Запускается непосредственно ejabberd'овским listener'ом при
установке каждого нового соединения. Реализует протокол согласно стандарту.
Для парсинга сообщений использует модуль *websocket_frame*.

### websocket\_xmpp.erl

Конечный автомат, парсящий поток XMPP-сообщений и взаимодействующий с ядром
ejabberd'а. Вебсокет посылает ему данные с помощью единственной функции
*process_request*. Для каждого вебсокета запускается один процесс *websocket_xmpp*.
Код почти без изменений взят из оригинального модуля.

### websocket\_frame.erl

Здесь реализована функциональность, позволяющая парсить (*parse_stream*) и
формировать (_make*_) WebSocket-фреймы согласно
[стандарту](https://tools.ietf.org/html/rfc6455).

### socket\_async.erl

Обёртка вокруг сокета, реализующая асинхронный режим работы ({active, once})
через синхронный (recv). Необходима, потому что в tls-сокетах ejabberd'а
асинхронный режим работы не реализован, а эрланговская реализация tls криво
работает с цепочками сертификатов.

